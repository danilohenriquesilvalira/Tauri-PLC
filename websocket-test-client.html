<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Test</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: system-ui, sans-serif; background: #F1F4F4; color: #212E3E; padding: 16px; }
        .container { max-width: 1000px; margin: 0 auto; }
        .card { background: white; border: 1px solid #BECACC; border-radius: 8px; padding: 16px; margin-bottom: 12px; }
        .card h3 { font-size: 14px; font-weight: 600; margin-bottom: 12px; color: #212E3E; }
        .row { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
        input[type="text"] { flex: 1; padding: 8px 12px; border: 1px solid #BECACC; border-radius: 6px; font-size: 14px; }
        button { padding: 8px 16px; border: none; border-radius: 6px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .btn-primary { background: #212E3E; color: white; }
        .btn-success { background: #28FF52; color: #212E3E; }
        .btn-danger { background: #dc2626; color: white; }
        .btn-secondary { background: #BECACC; color: #212E3E; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }
        .status { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 600; }
        .status.on { background: #d1fae5; color: #065f46; }
        .status.off { background: #fee2e2; color: #991b1b; }
        .chips { display: flex; flex-wrap: wrap; gap: 6px; margin: 8px 0; }
        .chip { display: flex; align-items: center; gap: 4px; padding: 6px 10px; border-radius: 6px; font-size: 12px; cursor: pointer; border: 1px solid #BECACC; background: #F1F4F4; }
        .chip.active { background: #212E3E; color: white; border-color: #212E3E; }
        .chip input { display: none; }
        .messages { max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 11px; background: #f8f9fa; border: 1px solid #BECACC; border-radius: 6px; }
        .msg { padding: 8px 12px; border-bottom: 1px solid #eee; }
        .msg:last-child { border-bottom: none; }
        .msg-time { color: #7C9599; font-size: 10px; }
        .msg-sys { background: #e0f2fe; color: #0369a1; }
        .msg-err { background: #fee2e2; color: #991b1b; }
        .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 12px; }
        .stat { background: white; border: 1px solid #BECACC; border-radius: 6px; padding: 12px; text-align: center; }
        .stat-val { font-size: 20px; font-weight: 700; }
        .stat-lbl { font-size: 10px; color: #7C9599; text-transform: uppercase; }
        .section-title { font-size: 11px; font-weight: 600; color: #7C9599; text-transform: uppercase; margin-bottom: 6px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="stats">
            <div class="stat"><div class="stat-val" id="msgCount">0</div><div class="stat-lbl">Mensagens</div></div>
            <div class="stat"><div class="stat-val" id="tagCount">0</div><div class="stat-lbl">Tags</div></div>
            <div class="stat"><div class="stat-val" id="plcCount">0</div><div class="stat-lbl">PLCs</div></div>
            <div class="stat"><div class="stat-val" id="uptime">0s</div><div class="stat-lbl">Tempo</div></div>
        </div>

        <div class="card">
            <h3>Conexao</h3>
            <div class="row">
                <input type="text" id="url" value="ws://localhost:8765" placeholder="ws://localhost:8765">
                <button class="btn-primary" id="btnConnect" onclick="connect()">Conectar</button>
                <button class="btn-danger" id="btnDisconnect" onclick="disconnect()" disabled>Desconectar</button>
                <span class="status off" id="status">Desconectado</span>
            </div>
        </div>

        <div class="card" id="filtersCard" style="display:none;">
            <h3>Filtros de Subscricao</h3>
            
            <div class="section-title">PLCs</div>
            <div class="chips" id="plcChips">Carregando...</div>
            
            <div class="section-title">Areas</div>
            <div class="chips" id="areaChips">
                <label class="chip active"><input type="checkbox" value="ENH" checked>ENH</label>
                <label class="chip active"><input type="checkbox" value="ESV" checked>ESV</label>
                <label class="chip active"><input type="checkbox" value="PJU" checked>PJU</label>
                <label class="chip active"><input type="checkbox" value="PMO" checked>PMO</label>
                <label class="chip active"><input type="checkbox" value="SCO" checked>SCO</label>
                <label class="chip active"><input type="checkbox" value="EDR" checked>EDR</label>
                <label class="chip active"><input type="checkbox" value="GER" checked>GER</label>
            </div>
            
            <div class="section-title">Categorias</div>
            <div class="chips" id="catChips">
                <label class="chip active"><input type="checkbox" value="PROC" checked>PROC</label>
                <label class="chip active"><input type="checkbox" value="FAULT" checked>FAULT</label>
                <label class="chip active"><input type="checkbox" value="EVENT" checked>EVENT</label>
                <label class="chip active"><input type="checkbox" value="ALARM" checked>ALARM</label>
                <label class="chip active"><input type="checkbox" value="CMD" checked>CMD</label>
            </div>
            
            <div class="row" style="margin-top:12px;">
                <button class="btn-success" onclick="subscribe()">Aplicar Filtros</button>
                <button class="btn-secondary" onclick="selectAll()">Todos</button>
                <button class="btn-secondary" onclick="selectNone()">Nenhum</button>
                <label style="margin-left:auto;font-size:12px;display:flex;align-items:center;gap:4px;">
                    <input type="checkbox" id="allFaults" checked> Sempre receber FAULT
                </label>
            </div>
            <div id="subStatus" style="margin-top:8px;font-size:12px;color:#7C9599;">Clique em Aplicar Filtros</div>
        </div>

        <div class="card">
            <div class="row" style="margin-bottom:8px;">
                <h3 style="margin:0;">Dados Recebidos</h3>
                <button class="btn-secondary" onclick="clearMsgs()" style="margin-left:auto;padding:4px 8px;font-size:11px;">Limpar</button>
            </div>
            <div class="messages" id="msgs"><div class="msg">Aguardando conexao...</div></div>
        </div>
    </div>

    <script>
        let ws = null;
        let clientId = 'test-' + Math.random().toString(36).substr(2, 6);
        let plcs = [];
        let startTime = null;
        let msgCount = 0;
        let tagCount = 0;
        let timer = null;

        // Chips toggle
        document.querySelectorAll('.chip').forEach(chip => {
            chip.onclick = () => {
                const cb = chip.querySelector('input');
                cb.checked = !cb.checked;
                chip.classList.toggle('active', cb.checked);
            };
        });

        function connect() {
            const url = document.getElementById('url').value;
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                updateStatus(true);
                startTime = Date.now();
                timer = setInterval(updateUptime, 1000);
                ws.send(JSON.stringify({ type: 'LIST_PLCS', client_id: clientId }));
                document.getElementById('filtersCard').style.display = 'block';
                addMsg('[SISTEMA] Conectado!', 'sys');
            };
            
            ws.onclose = () => {
                updateStatus(false);
                clearInterval(timer);
                addMsg('[SISTEMA] Desconectado', 'err');
            };
            
            ws.onerror = () => addMsg('[ERRO] Falha na conexao', 'err');
            
            ws.onmessage = (e) => handleMsg(e.data);
        }

        function disconnect() {
            if (ws) ws.close();
        }

        function updateStatus(on) {
            document.getElementById('status').className = 'status ' + (on ? 'on' : 'off');
            document.getElementById('status').textContent = on ? 'Conectado' : 'Desconectado';
            document.getElementById('btnConnect').disabled = on;
            document.getElementById('btnDisconnect').disabled = !on;
        }

        function handleMsg(data) {
            // MessagePack
            if (data.startsWith('MSGPACK:')) {
                try {
                    const bin = atob(data.substring(8));
                    const bytes = new Uint8Array(bin.length);
                    for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
                    const decoded = decodeMsgPack(bytes);
                    showData(decoded);
                } catch(e) { console.error(e); }
                return;
            }
            
            // JSON
            try {
                const json = JSON.parse(data);
                
                if (json.type === 'PLC_LIST') {
                    plcs = json.plcs || [];
                    renderPlcs();
                    document.getElementById('plcCount').textContent = plcs.length;
                    addMsg('[SISTEMA] ' + plcs.length + ' PLCs encontrados', 'sys');
                    return;
                }
                
                if (json.type === 'SUBSCRIBE_ACK') {
                    const parts = [];
                    if (json.plcs?.length) parts.push(json.plcs.length + ' PLCs');
                    if (json.areas?.length) parts.push('Areas: ' + json.areas.join(','));
                    if (json.categories?.length) parts.push('Cat: ' + json.categories.join(','));
                    document.getElementById('subStatus').innerHTML = '<b style="color:#16a34a">OK:</b> ' + parts.join(' | ');
                    addMsg('[SISTEMA] Filtros aplicados!', 'sys');
                    return;
                }
                
                showData(json);
            } catch(e) { console.error(e); }
        }

        function showData(data) {
            msgCount++;
            document.getElementById('msgCount').textContent = msgCount;
            
            const keys = Object.keys(data).filter(k => !['plc_ip','timestamp','type'].includes(k));
            tagCount += keys.length;
            document.getElementById('tagCount').textContent = tagCount;
            
            const div = document.createElement('div');
            div.className = 'msg';
            
            let info = '';
            if (data.plc_ip) info = '<b>[' + data.plc_ip + ']</b> ';
            
            div.innerHTML = '<span class="msg-time">' + new Date().toLocaleTimeString() + '</span> ' + info + '<br>' + JSON.stringify(data, null, 1);
            
            const msgs = document.getElementById('msgs');
            if (msgs.children[0]?.textContent === 'Aguardando conexao...') msgs.innerHTML = '';
            msgs.insertBefore(div, msgs.firstChild);
            while (msgs.children.length > 30) msgs.removeChild(msgs.lastChild);
        }

        function addMsg(text, type) {
            const div = document.createElement('div');
            div.className = 'msg msg-' + type;
            div.innerHTML = '<span class="msg-time">' + new Date().toLocaleTimeString() + '</span> ' + text;
            const msgs = document.getElementById('msgs');
            if (msgs.children[0]?.textContent === 'Aguardando conexao...') msgs.innerHTML = '';
            msgs.insertBefore(div, msgs.firstChild);
        }

        function clearMsgs() {
            document.getElementById('msgs').innerHTML = '<div class="msg">Limpo</div>';
            msgCount = 0; tagCount = 0;
            document.getElementById('msgCount').textContent = '0';
            document.getElementById('tagCount').textContent = '0';
        }

        function renderPlcs() {
            const container = document.getElementById('plcChips');
            if (!plcs.length) { container.innerHTML = 'Nenhum PLC'; return; }
            container.innerHTML = plcs.map(ip => '<label class="chip active"><input type="checkbox" value="' + ip + '" checked>' + ip + '</label>').join('');
            container.querySelectorAll('.chip').forEach(chip => {
                chip.onclick = () => {
                    const cb = chip.querySelector('input');
                    cb.checked = !cb.checked;
                    chip.classList.toggle('active', cb.checked);
                };
            });
        }

        function subscribe() {
            if (!ws || ws.readyState !== 1) { alert('Nao conectado!'); return; }
            
            const selPlcs = Array.from(document.querySelectorAll('#plcChips input:checked')).map(c => c.value);
            const selAreas = Array.from(document.querySelectorAll('#areaChips input:checked')).map(c => c.value);
            const selCats = Array.from(document.querySelectorAll('#catChips input:checked')).map(c => c.value);
            const allFaults = document.getElementById('allFaults').checked;
            
            const msg = {
                type: 'SUBSCRIBE',
                client_id: clientId,
                plc_ips: selPlcs,
                areas: selAreas,
                categories: selCats,
                include_all_faults: allFaults
            };
            
            console.log('Enviando:', msg);
            ws.send(JSON.stringify(msg));
            
            document.getElementById('subStatus').textContent = 'Enviado... aguardando confirmacao';
        }

        function selectAll() {
            document.querySelectorAll('#plcChips .chip, #areaChips .chip, #catChips .chip').forEach(c => {
                c.classList.add('active');
                c.querySelector('input').checked = true;
            });
        }

        function selectNone() {
            document.querySelectorAll('#plcChips .chip, #areaChips .chip, #catChips .chip').forEach(c => {
                c.classList.remove('active');
                c.querySelector('input').checked = false;
            });
        }

        function updateUptime() {
            if (!startTime) return;
            const s = Math.floor((Date.now() - startTime) / 1000);
            const m = Math.floor(s / 60);
            document.getElementById('uptime').textContent = m > 0 ? m + 'm' + (s%60) + 's' : s + 's';
        }

        // Simple MsgPack decoder
        function decodeMsgPack(bytes) {
            let pos = 0;
            function read() {
                const t = bytes[pos++];
                if (t <= 0x7f) return t;
                if ((t & 0xf0) === 0x80) { const n = t & 0x0f; const o = {}; for(let i=0;i<n;i++) o[read()]=read(); return o; }
                if ((t & 0xf0) === 0x90) { const n = t & 0x0f; const a = []; for(let i=0;i<n;i++) a.push(read()); return a; }
                if ((t & 0xe0) === 0xa0) { const n = t & 0x1f; let s=''; for(let i=0;i<n;i++) s+=String.fromCharCode(bytes[pos++]); return s; }
                if (t >= 0xe0) return t - 256;
                if (t === 0xc0) return null;
                if (t === 0xc2) return false;
                if (t === 0xc3) return true;
                if (t === 0xca) { const v = new DataView(new ArrayBuffer(4)); for(let i=0;i<4;i++) v.setUint8(i,bytes[pos++]); return v.getFloat32(0,false); }
                if (t === 0xcb) { const v = new DataView(new ArrayBuffer(8)); for(let i=0;i<8;i++) v.setUint8(i,bytes[pos++]); return v.getFloat64(0,false); }
                if (t === 0xcc) return bytes[pos++];
                if (t === 0xcd) return (bytes[pos++]<<8)|bytes[pos++];
                if (t === 0xce) return (bytes[pos++]<<24)|(bytes[pos++]<<16)|(bytes[pos++]<<8)|bytes[pos++];
                if (t === 0xd9) { const n = bytes[pos++]; let s=''; for(let i=0;i<n;i++) s+=String.fromCharCode(bytes[pos++]); return s; }
                if (t === 0xda) { const n = (bytes[pos++]<<8)|bytes[pos++]; let s=''; for(let i=0;i<n;i++) s+=String.fromCharCode(bytes[pos++]); return s; }
                if (t === 0xdc) { const n = (bytes[pos++]<<8)|bytes[pos++]; const a = []; for(let i=0;i<n;i++) a.push(read()); return a; }
                if (t === 0xde) { const n = (bytes[pos++]<<8)|bytes[pos++]; const o = {}; for(let i=0;i<n;i++) o[read()]=read(); return o; }
                return null;
            }
            return read();
        }

        document.getElementById('url').onkeypress = (e) => { if (e.key === 'Enter') connect(); };
    </script>
</body>
</html>
